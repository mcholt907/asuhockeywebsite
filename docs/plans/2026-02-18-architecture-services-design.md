# Architecture Design: Wire Up Scrapers + Extract Services

**Date:** 2026-02-18
**Status:** Approved

## Problem

Two architecture issues identified during codebase review:

1. `/api/recruits` reads from a static `asu_hockey_data.json` file instead of using the
   already-written `recruiting-scraper.js` (`fetchRecruitingData()`).
2. `/api/roster` reads its base data from the same static JSON (generated by the offline
   Python `scraper.py`) and embeds ~100 lines of merge/utility logic directly in `server.js`.

The static JSON is a deployment-time artifact. Any data update requires running `scraper.py`
manually and redeploying. The JS scrapers already exist and have caching — they just aren't
wired up.

## Chosen Approach: Option A — Wire up existing scrapers, extract services

### Data Flow (after)

```
/api/recruits  →  fetchRecruitingData()  →  SWR cache  →  EP scraper
/api/roster    →  rosterService.getRoster()  →  scrapeCHNRoster()
```

### New Files

**`services/roster-service.js`**
Extracts from `server.js`:
- `getRoster()` — merges CHN live roster data, generates EliteProspects links
- `determineNationality(hometown)` — maps hometown strings to ISO country codes
- Removes dependency on `asu_hockey_data.json` for roster base data

**`services/hockey-data-service.js`**
Thin wrapper for `getHockeyData()` (reading `asu_hockey_data.json`). Kept for now as
`asu_hockey_data.json` is still used by `/api/recruits` as a fallback during the
transition. Will be unused once `fetchRecruitingData()` is fully wired.

### Changes to Existing Files

**`recruiting-scraper.js`**
- Add SWR pattern to `fetchRecruitingData()` matching `scrapeCHNStats()` / `scrapeCHNRoster()`
- Add module-level `recruitingPromise` for request coalescing

**`server.js`**
- `/api/recruits`: replace `fs.readFile` + JSON parse with `fetchRecruitingData()`
- `/api/roster`: replace inline merge logic + `getHockeyData()` call with `rosterService.getRoster()`
- Remove `determineNationality()`, `getHockeyData()`, and inline merge helpers
- Remove `fs` import (no longer needed)

### What Does Not Change

- `asu_hockey_data.json` — kept on disk, becomes unused by the server
- `scraper.py` — untouched
- All existing cache keys, SWR timing, and request coalescing patterns
- All other API endpoints (`/api/news`, `/api/schedule`, `/api/stats`, `/api/transfers`, `/api/alumni`)

## Tests (TDD)

- `__tests__/recruiting-scraper.test.js` — SWR caching tests for `fetchRecruitingData()`
- `__tests__/roster-service.test.js` — unit tests for `determineNationality()` and merge logic

## Out of Scope

- Deleting `scraper.py` (deferred — kept as a reference/fallback)
- Admin UI for data editing
- Database migration
